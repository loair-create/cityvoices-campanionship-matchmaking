<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Companionship Matching Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f3f4f6; height: 100vh; overflow: hidden; }
    .app { display: flex; height: 100%; }
    .sidebar { width: 240px; background: #134e4a; color: white; padding: 16px; flex-shrink: 0; }
    .sidebar h1 { font-size: 1.1rem; margin: 0 0 20px 0; padding-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .tab-btn { display: block; width: 100%; padding: 12px 16px; margin-bottom: 4px; border: none; border-radius: 6px; background: transparent; color: rgba(255,255,255,0.9); text-align: left; font-size: 14px; cursor: pointer; }
    .tab-btn:hover { background: rgba(255,255,255,0.1); }
    .tab-btn.active { background: #0f766e; font-weight: 600; }
    .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; background: #f9fafb; min-height: 0; }
    .tab-panel { display: none; flex: 1; flex-direction: column; overflow: auto; padding: 24px; min-height: 0; }
    .tab-panel.active { display: flex !important; }
    .page-title { font-size: 1.25rem; font-weight: 700; color: #111; margin: 0 0 16px 0; }
    .card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border: 1px solid #e5e7eb; margin-bottom: 12px; overflow: hidden; }
    .card-header { padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; }
    .card-header:hover { background: #f9fafb; }
    .avatar { width: 48px; height: 48px; border-radius: 50%; background: #ccfbf1; color: #0d9488; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; }
    .card-body { padding: 0 16px 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
    .btn { padding: 8px 16px; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; border: none; }
    .btn-primary { background: #0d9488; color: white; }
    .btn-primary:hover { background: #0f766e; }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn-danger { background: #fef2f2; color: #b91c1c; }
    .btn-danger:hover { background: #fee2e2; }
    .loader { width: 40px; height: 40px; border: 4px solid #e5e7eb; border-top-color: #0d9488; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 40px auto; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal { background: white; border-radius: 12px; max-width: 560px; width: 100%; max-height: 90vh; overflow: auto; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
    .modal-full { max-width: 720px; }
    .detail-section { margin: 20px 0; }
    .detail-section h3 { font-size: 12px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.05em; margin: 0 0 10px 0; padding-bottom: 6px; border-bottom: 1px solid #e5e7eb; }
    .filter-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .filter-item label { display: block; font-size: 11px; font-weight: 600; color: #6b7280; margin-bottom: 4px; }
    .filter-item select { width: 100%; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 13px; }
    .match-reasons { font-size: 12px; color: #065f46; margin-top: 4px; }
    .card-ineligible { opacity: 0.85; background: #f9fafb; }
    .card-ineligible .avatar { background: #e5e7eb; color: #6b7280; }
    .card-ineligible .card-header:hover { background: #f3f4f6; }
    .match-reasons span { display: block; margin-top: 2px; }
    .modal-header { padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: flex-start; }
    .modal-header h2 { margin: 0; font-size: 1.25rem; }
    .modal-body { padding: 20px; }
    .detail-row { padding: 8px 0; border-bottom: 1px solid #f3f4f6; }
    .detail-row dt { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; margin: 0 0 2px 0; }
    .detail-row dd { margin: 0; font-size: 14px; color: #111; }
    .criteria-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e5e7eb; }
    .criteria-table th { background: #f9fafb; padding: 12px 16px; text-align: left; font-size: 12px; font-weight: 600; color: #6b7280; text-transform: uppercase; }
    .criteria-table td { padding: 12px 16px; border-top: 1px solid #e5e7eb; }
    .criteria-table input[type="number"] { width: 70px; padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; }
    .criteria-table input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 9999px; font-size: 12px; font-weight: 500; }
    .badge-amber { background: #fef3c7; color: #92400e; }
    .badge-green { background: #d1fae5; color: #065f46; }
    .match-row { display: flex; align-items: center; justify-content: space-between; padding: 16px; border-bottom: 1px solid #e5e7eb; flex-wrap: wrap; gap: 12px; }
    .match-row:last-child { border-bottom: none; }
    .match-info { display: flex; align-items: center; gap: 12px; }
    .match-actions { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .match-actions select { padding: 6px 10px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 13px; }
    .match-actions input { padding: 6px 10px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 13px; min-width: 180px; }
    .toolbar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .search-input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; width: 220px; }
    .weight-sum { font-size: 14px; color: #6b7280; margin-bottom: 12px; }
    .weight-sum.invalid { color: #b91c1c; font-weight: 600; }
    .weight-sum.valid { color: #059669; }
    .compare-table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 14px; table-layout: fixed; }
    .compare-table th { background: #f3f4f6; padding: 10px 12px; text-align: left; }
    .compare-table td { padding: 10px 12px; border-bottom: 1px solid #e5e7eb; }
    .compare-table .col-criteria { width: 22%; }
    .compare-table .col-person1, .compare-table .col-person2 { width: 39%; }
    .compare-table th:nth-child(1), .compare-table td:nth-child(1) { width: 22%; }
    .compare-table th:nth-child(2), .compare-table td:nth-child(2) { width: 39%; }
    .compare-table th:nth-child(3), .compare-table td:nth-child(3) { width: 39%; }
    .compare-table td.criteria-label { font-weight: 500; }
    .compare-table tr.compare-match-row td:nth-child(2), .compare-table tr.compare-match-row td:nth-child(3) { background: #d1fae5; color: #065f46; font-weight: 500; }
    .compare-section { margin: 20px 0; }
    .compare-section h3 { font-size: 1rem; margin: 0 0 12px 0; color: #374151; border-bottom: 1px solid #e5e7eb; padding-bottom: 8px; }
    .essay-block { margin-bottom: 20px; padding: 16px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; }
    .essay-block h4 { font-size: 13px; color: #6b7280; margin: 0 0 8px 0; }
    .essay-cols { display: flex; gap: 20px; margin-top: 8px; }
    .essay-col { flex: 1; min-width: 0; }
    .essay-col strong { display: block; font-size: 11px; color: #6b7280; margin-bottom: 4px; }
    .essay-col p { margin: 0; font-size: 14px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
    .modal-wide { max-width: 900px; }
  </style>
</head>
<body>
  <div class="app" id="app">
    <aside class="sidebar">
      <h1>Companionship Connections</h1>
      <button type="button" class="tab-btn active" data-tab="directory">Directory</button>
      <button type="button" class="tab-btn" data-tab="matches">Matches</button>
      <button type="button" class="tab-btn" data-tab="criteria">Criteria</button>
    </aside>
    <main class="main">
      <div id="loading" style="padding: 40px; text-align: center;">
        <div class="loader"></div>
        <p style="color: #6b7280; margin-top: 12px;">Loading dashboard...</p>
      </div>
      <div id="content" style="display: none; flex: 1; flex-direction: column; overflow: hidden; min-height: 0;">
        <div id="panel-directory" class="tab-panel"></div>
        <div id="panel-matches" class="tab-panel"></div>
        <div id="panel-criteria" class="tab-panel"></div>
      </div>
    </main>
  </div>

  <script>
    (function() {
      'use strict';

      var DEFAULT_CRITERIA = [
        { key: 'preferredContact', label: 'Preferred Contact Method', weight: 25, category: 'Contact', enabled: true },
        { key: 'availability', label: 'Availability', weight: 25, category: 'Logistics', enabled: true },
        { key: 'borough', label: 'Borough', weight: 12, category: 'Logistics', enabled: true },
        { key: 'willingToTravel', label: 'Willing to Travel', weight: 5, category: 'Logistics', enabled: true },
        { key: 'age', label: 'Age', weight: 4, category: 'Identity', enabled: true },
        { key: 'pronouns', label: 'Pronouns', weight: 3, category: 'Identity', enabled: true },
        { key: 'gender', label: 'Gender', weight: 3, category: 'Identity', enabled: true },
        { key: 'lgbtq', label: 'LGBTQ+', weight: 9, category: 'Identity', enabled: true },
        { key: 'hasExperiencedDV', label: 'DV Survivor', weight: 2, category: 'Experience', enabled: true },
        { key: 'hasBeenIncarcerated', label: 'Incarceration', weight: 2, category: 'Experience', enabled: true },
        { key: 'isVeteran', label: 'Veteran', weight: 2, category: 'Experience', enabled: true }
      ];

      var ESSAY_LABELS = {
        hobbies: 'What are your hobbies?',
        expectations: 'What do you want from a Companion?',
        sharedExperiences: 'Life experiences in common?',
        motivation: 'Why are you interested?',
        creativity: 'How do you express creativity?'
      };

      var state = {
        companions: [],
        matches: [],
        criteria: [],
        activeTab: 'directory',
        selectedCompanion: null,
        directoryFilters: {}
      };

      var FILTER_FIELDS = [
        { key: 'waiverSigned', label: 'Waiver Signed (eligible to match)' },
        { key: 'preferredContact', label: 'Preferred Contact Method' },
        { key: 'borough', label: 'Borough' },
        { key: 'willingToTravel', label: 'Willing To Travel' },
        { key: 'age', label: 'Age' },
        { key: 'pronouns', label: 'Pronouns' },
        { key: 'gender', label: 'Gender' },
        { key: 'raceEthnicity', label: 'Race/Ethnicity' },
        { key: 'lgbtq', label: 'LGBTQ+' },
        { key: 'hasExperiencedDV', label: 'DV Survivor' },
        { key: 'hasBeenIncarcerated', label: 'Incarceration' },
        { key: 'hasExperiencedHomelessness', label: 'Homelessness' },
        { key: 'receivingMentalHealthServices', label: 'Mental Health Svcs' },
        { key: 'isVeteran', label: 'Veteran' }
      ];

      function loadData() {
        if (typeof google === 'undefined' || !google.script || !google.script.run) {
          document.getElementById('loading').innerHTML = '<p style="color: #b91c1c;">This app must be run from Google Apps Script (Deploy as web app or Test as web app).</p>';
          return;
        }
        google.script.run
          .withSuccessHandler(function(data) {
            state.companions = data.companions || [];
            state.matches = data.matches || [];
            var saved = (data.criteria && data.criteria.length) ? data.criteria : [];
            var byKey = {};
            saved.forEach(function(item) { byKey[item.key] = item; });
            state.criteria = DEFAULT_CRITERIA.map(function(defaultItem) {
              var s = byKey[defaultItem.key];
              return s ? { key: s.key, label: s.label || defaultItem.label, weight: s.weight, category: s.category || defaultItem.category, enabled: s.enabled !== false } : JSON.parse(JSON.stringify(defaultItem));
            });
            Object.keys(byKey).forEach(function(k) {
              if (!DEFAULT_CRITERIA.some(function(d) { return d.key === k; })) state.criteria.push(byKey[k]);
            });
            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'flex';
            showTab('directory');
          })
          .withFailureHandler(function(err) {
            document.getElementById('loading').innerHTML = '<p style="color: #b91c1c;">Failed to load: ' + (err.message || String(err)) + '</p>';
          })
          .getData();
      }

      function showTab(tabName) {
        state.activeTab = tabName;
        state.selectedCompanion = null;
        document.querySelectorAll('.tab-btn').forEach(function(btn) {
          btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
        });
        document.querySelectorAll('.tab-panel').forEach(function(panel) {
          panel.classList.toggle('active', panel.id === 'panel-' + tabName);
        });
        if (tabName === 'directory') renderDirectory();
        else if (tabName === 'matches') renderMatches();
        else if (tabName === 'criteria') renderCriteria();
      }

      function getOverlappingDays(c1, c2) {
        var days = ['monday','tuesday','wednesday','thursday','friday','saturday','sunday'];
        var out = [];
        for (var d = 0; d < days.length; d++) {
          var key = days[d];
          var a = (c1.availability && c1.availability[key]) || '';
          var b = (c2.availability && c2.availability[key]) || '';
          if (a && b && a !== 'Unavailable' && b !== 'Unavailable') out.push(key.charAt(0).toUpperCase() + key.slice(1));
        }
        return out;
      }

      function calculateMatchPercentAndReasons(c1, c2) {
        var config = state.criteria;
        var score = 0, maxScore = 0, reasons = [];
        for (var i = 0; i < config.length; i++) {
          if (config[i].enabled) maxScore += config[i].weight;
        }
        if (maxScore === 0) return { percent: 0, reasons: [] };
        var cm = {};
        for (var j = 0; j < config.length; j++) { cm[config[j].key] = config[j]; }
        if ((c1.preferredContact || '') === (c2.preferredContact || '') && (c1.preferredContact || c2.preferredContact)) {
          if (cm.preferredContact && cm.preferredContact.enabled) { score += (cm.preferredContact.weight || 25); reasons.push('Same preferred contact method'); }
        }
        if (c1.borough === c2.borough && c1.borough) {
          if (cm.borough && cm.borough.enabled) { score += (cm.borough.weight || 12); reasons.push('Same borough (' + (c1.borough || '') + ')'); }
        } else if ((c1.willingToTravel === 'Yes' || c2.willingToTravel === 'Yes') && cm.willingToTravel && cm.willingToTravel.enabled) {
          score += (cm.willingToTravel.weight || 5);
          reasons.push('Willing to travel');
        }
        if (c1.age === c2.age && c1.age && cm.age && cm.age.enabled) { score += (cm.age.weight || 4); reasons.push('Same age group'); }
        if (c1.pronouns === c2.pronouns && c1.pronouns && cm.pronouns && cm.pronouns.enabled) { score += (cm.pronouns.weight || 3); reasons.push('Same pronouns'); }
        if (c1.gender === c2.gender && c1.gender && cm.gender && cm.gender.enabled) { score += (cm.gender.weight || 3); reasons.push('Same gender'); }
        if (c1.lgbtq === 'Yes' && c2.lgbtq === 'Yes' && cm.lgbtq && cm.lgbtq.enabled) { score += (cm.lgbtq.weight || 9); reasons.push('Both LGBTQ+'); }
        var overlaps = getOverlappingDays(c1, c2);
        if (overlaps.length > 0 && cm.availability && cm.availability.enabled) {
          score += ((cm.availability.weight || 25) * Math.min(1, overlaps.length / 3));
          reasons.push(overlaps.length + ' overlapping day(s)');
        }
        return { percent: Math.round((score / maxScore) * 100), reasons: reasons };
      }

      function calculateMatchPercent(c1, c2) {
        return calculateMatchPercentAndReasons(c1, c2).percent;
      }

      function renderDirectory() {
        var panel = document.getElementById('panel-directory');
        var search = (panel.querySelector('.search-input') && panel.querySelector('.search-input').value) || '';
        var filtersHtml = FILTER_FIELDS.map(function(f) {
          var val = state.directoryFilters[f.key] || '';
          var options = ['<option value="">All</option>'];
          var uniq = {};
          state.companions.forEach(function(c) {
            var v = c[f.key];
            if (v === true || v === false) v = v ? 'Yes' : 'No';
            else v = (v && String(v).trim()) || '';
            if (v && !uniq[v]) { uniq[v] = true; options.push('<option value="' + escapeHtml(String(v)) + '"' + (val === String(v) ? ' selected' : '') + '>' + escapeHtml(String(v)) + '</option>'); }
          });
          return '<div class="filter-item"><label>' + escapeHtml(f.label) + '</label><select data-filter="' + f.key + '">' + options.join('') + '</select></div>';
        }).join('');
        var showFilters = (panel.querySelector('.filter-toggle') && panel.querySelector('.filter-toggle').getAttribute('data-open') === '1') ? true : false;
        var html = '<div class="toolbar"><input type="text" class="search-input" placeholder="Search names..." value="' + (search || '').replace(/"/g, '&quot;') + '"><button type="button" class="btn btn-secondary" onclick="window.appRefresh()">Refresh</button>' +
          ' <button type="button" class="btn btn-secondary filter-toggle" data-open="' + (showFilters ? '1' : '0') + '">' + (showFilters ? 'Hide filters' : 'Filters') + '</button></div>' +
          (showFilters ? '<div class="filter-grid" id="directory-filters">' + filtersHtml + '</div>' : '') +
          '<h1 class="page-title">Directory</h1><div class="grid" id="directory-grid"></div>';
        panel.innerHTML = html;
        if (showFilters) {
          panel.querySelectorAll('#directory-filters select').forEach(function(sel) {
            sel.addEventListener('change', function() {
              state.directoryFilters[this.getAttribute('data-filter')] = this.value || '';
              renderDirectory();
            });
          });
          panel.querySelector('.filter-toggle').addEventListener('click', function() {
            this.setAttribute('data-open', this.getAttribute('data-open') === '1' ? '0' : '1');
            renderDirectory();
          });
        } else {
          panel.querySelector('.filter-toggle').addEventListener('click', function() {
            this.setAttribute('data-open', '1');
            renderDirectory();
          });
        }
        var list = state.companions;
        if (search) {
          search = search.toLowerCase();
          list = list.filter(function(c) {
            return (c.firstName && c.firstName.toLowerCase().indexOf(search) !== -1) || (c.lastName && c.lastName.toLowerCase().indexOf(search) !== -1);
          });
        }
        for (var key in state.directoryFilters) {
          if (!state.directoryFilters[key]) continue;
          var filterVal = state.directoryFilters[key];
          list = list.filter(function(c) {
            var v = c[key];
            if (v === true || v === false) v = v ? 'Yes' : 'No';
            else v = (v && String(v).trim()) || '';
            return String(v) === filterVal;
          });
        }
        var grid = document.getElementById('directory-grid');
        list.forEach(function(c) {
          var card = document.createElement('div');
          card.className = 'card';
          var waiverNote = !c.waiverSigned;
          card.innerHTML = '<div class="card-header" data-id="' + c.id + '">' +
            '<div class="avatar">' + (c.firstName ? c.firstName.charAt(0) : '?') + '</div>' +
            '<div style="flex:1;min-width:0;">' +
              '<div style="font-weight:600;color:#111;">' + escapeHtml(c.firstName || '') + ' ' + escapeHtml(c.lastName || '') + '</div>' +
              '<div style="font-size:13px;color:#6b7280;">' + escapeHtml(c.borough || '') + '</div>' +
              (waiverNote ? '<span class="badge badge-amber" style="margin-top:4px;">Waiver not signed</span>' : '') +
            '</div>' +
            '</div>';
          card.querySelector('.card-header').addEventListener('click', function() { openCompanionModal(c.id); });
          grid.appendChild(card);
        });
        var searchEl = panel.querySelector('.search-input');
        if (searchEl) searchEl.addEventListener('input', function() { renderDirectory(); });
      }

      function escapeHtml(s) {
        if (s == null) return '';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      function downloadCompanionPDF(companionId) {
        var c = state.companions.find(function(x) { return String(x.id) === String(companionId); });
        if (!c) return;
        function doPdf() {
          try {
            var jspdfLib = window.jspdf;
            if (!jspdfLib || !jspdfLib.jsPDF) {
              alert('PDF library not loaded. Use browser Print (Ctrl+P or Cmd+P) and choose "Save as PDF".');
              return;
            }
            var jsPDF = jspdfLib.jsPDF;
            var doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'letter' });
            var margin = 40;
            var y = margin;
            var lineH = 16;
            function addLine(label, value) {
              if (y > 700) { doc.addPage(); y = margin; }
              doc.setFontSize(9);
              doc.setFont(undefined, 'normal');
              doc.text((label ? label + ': ' : '') + (value || '—'), margin, y);
              y += lineH;
            }
            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.text((c.firstName || '') + ' ' + (c.lastName || '') + ' — Companion Application', margin, y);
            y += lineH + 8;
            doc.setFontSize(10);
            addLine('Preferred Contact Method', c.preferredContact);
            addLine('Email', c.email);
            addLine('Phone', c.phone);
            addLine('Willing To Travel', c.willingToTravel);
            addLine('Accessibility Needs', c.accessibilityNeeds);
            addLine('Borough', c.borough);
            addLine('Neighborhood', c.neighborhood);
            addLine('Age', c.age);
            addLine('Pronouns', c.pronouns);
            addLine('Gender', c.gender);
            addLine('Race/Ethnicity', c.raceEthnicity);
            addLine('LGBTQ+', c.lgbtq);
            addLine('Relationship Status', c.relationshipStatus);
            y += 4;
            doc.setFont(undefined, 'bold');
            doc.setFontSize(10);
            doc.text('Lived Experience', margin, y);
            y += lineH;
            doc.setFont(undefined, 'normal');
            addLine('Experienced Domestic Violence', c.hasExperiencedDV);
            addLine('Been Incarcerated', c.hasBeenIncarcerated);
            addLine('Experienced Homelessness', c.hasExperiencedHomelessness);
            addLine('Receiving Mental Health Services', c.receivingMentalHealthServices);
            addLine('Receiving Substance Use Services', c.receivingSubstanceUseServices);
            addLine('Veteran', c.isVeteran);
            y += 4;
            doc.setFont(undefined, 'bold');
            doc.text('Availability', margin, y);
            y += lineH;
            doc.setFont(undefined, 'normal');
            var days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
            days.forEach(function(d) { addLine(d, (c.availability && c.availability[d.toLowerCase()]) || '—'); });
            if (c.internalNotes) { y += 4; doc.setFont(undefined, 'bold'); doc.text('Internal Notes', margin, y); y += lineH; doc.setFont(undefined, 'normal'); var lines = doc.splitTextToSize(c.internalNotes || '', 500); lines.forEach(function(l) { if (y > 700) { doc.addPage(); y = margin; } doc.text(l, margin, y); y += lineH; }); y += 4; }
            doc.setFont(undefined, 'bold');
            doc.text('Essay Responses', margin, y);
            y += lineH;
            doc.setFont(undefined, 'normal');
            ['hobbies','expectations','sharedExperiences','motivation','creativity'].forEach(function(k) {
              var q = ESSAY_LABELS[k] || k;
              var text = (c.essays && c.essays[k]) || '—';
              doc.setFont(undefined, 'bold');
              doc.setFontSize(9);
              doc.text(q, margin, y);
              y += lineH;
              doc.setFont(undefined, 'normal');
              var lines = doc.splitTextToSize(String(text), 500);
              lines.forEach(function(l) { if (y > 700) { doc.addPage(); y = margin; } doc.text(l, margin, y); y += lineH; });
              y += 8;
            });
            doc.save('Companion_' + (c.firstName || '').replace(/\s+/g, '_') + '_' + (c.lastName || '').replace(/\s+/g, '_') + '.pdf');
          } catch (e) {
            alert('PDF failed. Try Print (Ctrl+P) and "Save as PDF".');
          }
        }
        if (window.jspdf && window.jspdf.jsPDF) { doPdf(); return; }
        var script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
        script.onload = function() { doPdf(); };
        script.onerror = function() { alert('Could not load PDF library. Use Print and "Save as PDF".'); };
        document.head.appendChild(script);
      }

      function dr(label, value) {
        return '<div class="detail-row"><dt>' + escapeHtml(label) + '</dt><dd>' + escapeHtml(value || '—') + '</dd></div>';
      }

      function openCompanionModal(id) {
        var c = state.companions.find(function(x) { return String(x.id) === String(id); });
        if (!c) return;
        state.selectedCompanion = c;
        var avail = c.availability || {};
        var days = ['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday'];
        var availHtml = days.map(function(d) { return d + ': ' + (avail[d.toLowerCase()] || '—'); }).join(' | ');
        var contact = dr('Preferred Contact Method', c.preferredContact) + dr('Email', c.email) + dr('Phone', c.phone) + dr('Willing To Travel', c.willingToTravel) + dr('Accessibility Needs', c.accessibilityNeeds);
        var identity = dr('Borough', c.borough) + dr('Neighborhood', c.neighborhood) + dr('Age', c.age) + dr('Pronouns', c.pronouns) + dr('Gender', c.gender) + dr('Race/Ethnicity', c.raceEthnicity) + dr('LGBTQ+', c.lgbtq) + dr('Relationship Status', c.relationshipStatus);
        var lived = dr('Experienced Domestic Violence', c.hasExperiencedDV) + dr('Been Incarcerated', c.hasBeenIncarcerated) + dr('Experienced Homelessness', c.hasExperiencedHomelessness) + dr('Receiving Mental Health Services', c.receivingMentalHealthServices) + dr('Receiving Substance Use Services', c.receivingSubstanceUseServices) + dr('Ever Received Mental Health Services', c.historyMentalHealthServices) + dr('Ever Received Substance Use Services', c.historySubstanceUseServices) + dr('Veteran', c.isVeteran);
        var essaysHtml = '';
        ['hobbies','expectations','sharedExperiences','motivation','creativity'].forEach(function(k) {
          var q = ESSAY_LABELS[k] || k;
          var text = (c.essays && c.essays[k]) || '—';
          essaysHtml += '<div class="essay-block"><h4>' + escapeHtml(q) + '</h4><p>' + escapeHtml(text) + '</p></div>';
        });
        var body = '<div class="detail-section"><h3>Contact & Logistics</h3>' + contact + '</div>' +
          '<div class="detail-section"><h3>Identity</h3>' + identity + '</div>' +
          '<div class="detail-section"><h3>Lived Experience</h3>' + lived + '</div>' +
          '<div class="detail-section"><h3>Availability</h3><div class="detail-row"><dt>Days</dt><dd>' + escapeHtml(availHtml) + '</dd></div></div>' +
          (c.internalNotes ? '<div class="detail-section"><h3>Internal Notes</h3>' + dr('', c.internalNotes) + '</div>' : '') +
          '<div class="detail-section"><h3>Essay Responses</h3>' + essaysHtml + '</div>' +
          '<div style="margin-top:20px;">' +
            (!c.waiverSigned ? '<div style="margin-bottom:12px;padding:10px;background:#fef3c7;border-radius:6px;font-size:13px;color:#92400e;">Note: Waiver not signed (column B in form responses).</div>' : '') +
            '<button type="button" class="btn btn-secondary" onclick="window.downloadCompanionPDF(\'' + c.id + '\')">Download PDF</button> ' +
            '<button type="button" class="btn btn-primary" onclick="window.showFindMatch(\'' + c.id + '\')">Find Match</button> ' +
            '<button type="button" class="btn btn-danger" onclick="window.deleteCompanion(\'' + c.id + '\')">Delete application</button>' +
          '</div>';
        var modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'companion-modal';
        modal.innerHTML = '<div class="modal modal-full">' +
          '<div class="modal-header">' +
            '<h2>' + escapeHtml(c.firstName) + ' ' + escapeHtml(c.lastName) + ' — Full application</h2>' +
            '<button type="button" class="btn btn-secondary" onclick="document.getElementById(\'companion-modal\').remove()">Close</button>' +
          '</div>' +
          '<div class="modal-body">' + body + '</div></div>';
        modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
        document.body.appendChild(modal);
      }

      function showFindMatch(selectedId) {
        var c1 = state.companions.find(function(x) { return String(x.id) === String(selectedId); });
        if (!c1) return;
        var others = state.companions.filter(function(c) { return String(c.id) !== String(selectedId); });
        others.sort(function(a, b) { return calculateMatchPercent(c1, b) - calculateMatchPercent(c1, a); });
        others = others.slice(0, 10);
        var listHtml = others.map(function(c2) {
          var result = calculateMatchPercentAndReasons(c1, c2);
          var pct = result.percent;
          var reasons = (result.reasons || []).slice(0, 3);
          var reasonsHtml = reasons.length ? '<div class="match-reasons">' + reasons.map(function(r) { return '<span>' + escapeHtml(r) + '</span>'; }).join('') + '</div>' : '';
          return '<div class="match-row">' +
            '<div class="match-info"><span><strong>' + escapeHtml(c2.firstName) + ' ' + escapeHtml(c2.lastName) + '</strong></span> <span class="badge ' + (pct >= 70 ? 'badge-green' : '') + '">' + pct + '% match</span>' + reasonsHtml + '</div>' +
            '<button type="button" class="btn btn-primary" onclick="window.createMatch(\'' + c1.id + '\', \'' + c2.id + '\')">Select</button>' +
          '</div>';
        }).join('');
        var modal = document.getElementById('companion-modal');
        if (modal) modal.remove();
        var m = document.createElement('div');
        m.className = 'modal-overlay';
        m.id = 'find-match-modal';
        m.innerHTML = '<div class="modal" style="max-width:640px;">' +
          '<div class="modal-header"><h2>Find match for ' + escapeHtml(c1.firstName) + ' ' + escapeHtml(c1.lastName) + '</h2><button type="button" class="btn btn-secondary" onclick="document.getElementById(\'find-match-modal\').remove()">Back</button></div>' +
          '<div class="modal-body">' + (others.length ? listHtml : '<p>No eligible companions to match.</p>') + '</div></div>';
        m.addEventListener('click', function(e) { if (e.target === m) m.remove(); });
        document.body.appendChild(m);
      }

      function createMatch(id1, id2) {
        var c1 = state.companions.find(function(x) { return String(x.id) === String(id1); });
        var c2 = state.companions.find(function(x) { return String(x.id) === String(id2); });
        if (!c1 || !c2) return;
        var matchObj = {
          id: Math.random().toString(36).substring(2, 11),
          companion1Id: String(c1.id),
          companion2Id: String(c2.id),
          c1Name: (c1.firstName || '') + ' ' + (c1.lastName || ''),
          c2Name: (c2.firstName || '') + ' ' + (c2.lastName || ''),
          status: 'Just Matched',
          notes: '',
          createdAt: new Date().toISOString()
        };
        google.script.run.withSuccessHandler(function() {
          state.matches.unshift(matchObj);
          var mod = document.getElementById('find-match-modal');
          if (mod) mod.remove();
          showTab('matches');
        }).createMatch(matchObj);
      }

      function deleteCompanion(id) {
        if (!confirm('Delete this application? They will be removed from the spreadsheet and any matches.')) return;
        google.script.run.withSuccessHandler(function() { loadData(); }).deleteCompanion(id);
        var mod = document.getElementById('companion-modal');
        if (mod) mod.remove();
      }

      function appRefresh() { loadData(); }

      function renderMatches() {
        var panel = document.getElementById('panel-matches');
        panel.innerHTML = '<h1 class="page-title">Matches</h1><div id="matches-list"></div>';
        var list = document.getElementById('matches-list');
        if (state.matches.length === 0) {
          list.innerHTML = '<p style="color:#6b7280;">No matches yet. Use Directory to find a match for a companion.</p>';
          return;
        }
        state.matches.forEach(function(m) {
          var c1 = state.companions.find(function(c) { return String(c.id) === String(m.companion1Id); });
          var c2 = state.companions.find(function(c) { return String(c.id) === String(m.companion2Id); });
          var names = (c1 ? c1.firstName + ' ' + c1.lastName : '?') + ' & ' + (c2 ? c2.firstName + ' ' + c2.lastName : '?');
          var pct = (c1 && c2) ? calculateMatchPercent(c1, c2) : 0;
          var statuses = ['Just Matched', 'Introduction Sent', 'First Meeting Set', 'Active', 'Canceled'];
          var opts = statuses.map(function(s) { return '<option value="' + escapeHtml(s) + '"' + (m.status === s ? ' selected' : '') + '>' + s + '</option>'; }).join('');
          var row = document.createElement('div');
          row.className = 'card';
          row.innerHTML = '<div class="match-row">' +
            '<div class="match-info"><strong>' + escapeHtml(names) + '</strong> <span class="badge badge-green">' + pct + '%</span></div>' +
            '<div class="match-actions">' +
              '<button type="button" class="btn btn-primary" onclick="window.openMatchDetailModal(\'' + m.id + '\')">View</button>' +
              '<select data-match-id="' + m.id + '" data-field="status">' + opts + '</select>' +
              '<input type="text" placeholder="Notes" value="' + escapeHtml(m.notes || '') + '" data-match-id="' + m.id + '" data-field="notes">' +
              '<button type="button" class="btn btn-danger" onclick="window.removeMatch(\'' + m.id + '\')">Delete</button>' +
            '</div>' +
          '</div>';
          list.appendChild(row);
          (function(matchId) {
            row.querySelector('select').addEventListener('change', function() {
              var val = this.value;
              google.script.run.updateMatchData(matchId, 'status', val);
              var mm = state.matches.find(function(x) { return x.id === matchId; });
              if (mm) mm.status = val;
            });
            row.querySelector('input').addEventListener('change', function() {
              var val = this.value;
              google.script.run.updateMatchData(matchId, 'notes', val);
              var mm = state.matches.find(function(x) { return x.id === matchId; });
              if (mm) mm.notes = val;
            });
          })(m.id);
        });
      }

      function removeMatch(id) {
        if (!confirm('Delete this match?')) return;
        google.script.run.withSuccessHandler(function() {
          state.matches = state.matches.filter(function(m) { return m.id !== id; });
          renderMatches();
        }).deleteMatch(id);
      }

      function openMatchDetailModal(matchId) {
        var m = state.matches.find(function(x) { return x.id === matchId; });
        if (!m) return;
        var c1 = state.companions.find(function(c) { return String(c.id) === String(m.companion1Id); });
        var c2 = state.companions.find(function(c) { return String(c.id) === String(m.companion2Id); });
        if (!c1 || !c2) return;
        var pct = calculateMatchPercent(c1, c2);
        var overlaps = getOverlappingDays(c1, c2);
        var name1 = (c1.firstName || '') + ' ' + (c1.lastName || '');
        var name2 = (c2.firstName || '') + ' ' + (c2.lastName || '');

        function cmp(key, label) {
          var v1 = c1[key] || '—';
          var v2 = c2[key] || '—';
          var same = String(v1).toLowerCase().trim() === String(v2).toLowerCase().trim() && v1 !== '—' && v1 !== '';
          return '<tr class="' + (same ? 'compare-match-row' : '') + '"><td class="criteria-label">' + escapeHtml(label) + '</td><td>' + escapeHtml(v1) + '</td><td>' + escapeHtml(v2) + '</td></tr>';
        }

        var tableRows = cmp('preferredContact', 'Preferred Contact Method') +
          cmp('borough', 'Borough') +
          cmp('neighborhood', 'Neighborhood') +
          cmp('age', 'Age') +
          cmp('pronouns', 'Pronouns') +
          cmp('gender', 'Gender') +
          cmp('raceEthnicity', 'Race/Ethnicity') +
          cmp('lgbtq', 'LGBTQ+') +
          cmp('willingToTravel', 'Willing To Travel');
        function capDay(d) { return d.charAt(0).toUpperCase() + d.slice(1); }
        var avail1 = (c1.availability && Object.keys(c1.availability).map(function(d) { return (c1.availability[d] && c1.availability[d] !== 'Unavailable') ? capDay(d) : null; }).filter(Boolean).join(', ')) || '—';
        var avail2 = (c2.availability && Object.keys(c2.availability).map(function(d) { return (c2.availability[d] && c2.availability[d] !== 'Unavailable') ? capDay(d) : null; }).filter(Boolean).join(', ')) || '—';
        var availSame = avail1 === avail2;
        tableRows += '<tr class="' + (availSame ? 'compare-match-row' : '') + '"><td class="criteria-label">Availability</td><td>' + escapeHtml(avail1) + '</td><td>' + escapeHtml(avail2) + '</td></tr>';
        var overlapTxt = overlaps.length ? overlaps.join(', ') : 'None';
        tableRows += '<tr class="' + (overlaps.length ? 'compare-match-row' : '') + '"><td class="criteria-label">Overlapping Days</td><td>' + escapeHtml(overlapTxt) + '</td><td>' + escapeHtml(overlapTxt) + '</td></tr>';

        var essayHtml = '';
        var essayKeys = ['hobbies', 'expectations', 'sharedExperiences', 'motivation', 'creativity'];
        essayKeys.forEach(function(k) {
          var q = ESSAY_LABELS[k] || k;
          var t1 = (c1.essays && c1.essays[k]) || '—';
          var t2 = (c2.essays && c2.essays[k]) || '—';
          essayHtml += '<div class="essay-block">' +
            '<h4>' + escapeHtml(q) + '</h4>' +
            '<div class="essay-cols">' +
              '<div class="essay-col"><strong>' + escapeHtml(name1) + '</strong><p>' + escapeHtml(t1) + '</p></div>' +
              '<div class="essay-col"><strong>' + escapeHtml(name2) + '</strong><p>' + escapeHtml(t2) + '</p></div>' +
            '</div></div>';
        });

        var modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.id = 'match-detail-modal';
        modal.innerHTML = '<div class="modal modal-wide">' +
          '<div class="modal-header">' +
            '<h2>' + escapeHtml(name1) + ' & ' + escapeHtml(name2) + ' — ' + pct + '% match</h2>' +
            '<button type="button" class="btn btn-secondary" onclick="document.getElementById(\'match-detail-modal\').remove()">Close</button>' +
          '</div>' +
          '<div class="modal-body">' +
            '<div class="compare-section">' +
              '<h3>Application Comparison (Matches In Green)</h3>' +
              '<table class="compare-table">' +
                '<colgroup><col class="col-criteria"><col class="col-person1"><col class="col-person2"></colgroup>' +
                '<thead><tr><th>Criteria</th><th>' + escapeHtml(name1) + '</th><th>' + escapeHtml(name2) + '</th></tr></thead><tbody>' + tableRows + '</tbody>' +
              '</table></div>' +
            '<div class="compare-section">' +
              '<h3>Manual Essay Comparison</h3>' + essayHtml + '</div>' +
          '</div></div>';
        modal.addEventListener('click', function(e) { if (e.target === modal) modal.remove(); });
        document.body.appendChild(modal);
      }

      function renderCriteria() {
        var panel = document.getElementById('panel-criteria');
        var total = 0;
        state.criteria.forEach(function(c) { if (c.enabled) total += (parseInt(c.weight, 10) || 0); });
        var valid = total === 100;
        var rows = state.criteria.map(function(item, idx) {
          return '<tr>' +
            '<td><input type="checkbox" ' + (item.enabled ? 'checked' : '') + ' data-idx="' + idx + '"></td>' +
            '<td>' + escapeHtml(item.category) + '</td>' +
            '<td>' + escapeHtml(item.label) + '</td>' +
            '<td><input type="number" min="0" max="100" value="' + item.weight + '" data-idx="' + idx + '" ' + (item.enabled ? '' : 'disabled') + '></td>' +
          '</tr>';
        }).join('');
        panel.innerHTML = '<h1 class="page-title">Matching Criteria</h1>' +
          '<p class="weight-sum ' + (valid ? 'valid' : 'invalid') + '">Total weight (enabled only): ' + total + '% ' + (valid ? '— OK' : '— Must equal 100%') + '</p>' +
          '<table class="criteria-table"><thead><tr><th>Include</th><th>Category</th><th>Criteria</th><th>Weight</th></tr></thead><tbody>' + rows + '</tbody></table>' +
          '<div style="margin-top:16px;"><button type="button" class="btn btn-primary" ' + (valid ? '' : 'disabled') + ' id="save-criteria-btn">Save criteria</button></div>';
        panel.querySelectorAll('input[type="checkbox"]').forEach(function(cb) {
          cb.addEventListener('change', function() {
            state.criteria[parseInt(this.getAttribute('data-idx'), 10)].enabled = this.checked;
            panel.querySelectorAll('input[type="number"]')[parseInt(this.getAttribute('data-idx'), 10)].disabled = !this.checked;
            renderCriteria();
          });
        });
        panel.querySelectorAll('input[type="number"]').forEach(function(inp) {
          inp.addEventListener('change', function() {
            state.criteria[parseInt(this.getAttribute('data-idx'), 10)].weight = parseInt(this.value, 10) || 0;
            renderCriteria();
          });
        });
        document.getElementById('save-criteria-btn').addEventListener('click', function() {
          google.script.run.withSuccessHandler(function() { alert('Criteria saved.'); }).saveCriteriaSettings(JSON.stringify(state.criteria));
        });
      }

      document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.addEventListener('click', function() { showTab(btn.getAttribute('data-tab')); });
      });

      window.appRefresh = appRefresh;
      window.showFindMatch = showFindMatch;
      window.createMatch = createMatch;
      window.deleteCompanion = deleteCompanion;
      window.removeMatch = removeMatch;
      window.openMatchDetailModal = openMatchDetailModal;
      window.downloadCompanionPDF = downloadCompanionPDF;

      loadData();
    })();
  </script>
</body>
</html>
